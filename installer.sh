#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –æ—Ç –∏–º–µ–Ω–∏ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (root)
if [[ $EUID -ne 0 ]]; then
   echo "–û—à–∏–±–∫–∞: –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å –ø—Ä–∞–≤–∞–º–∏ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (sudo)."
   exit 1
fi

# –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
clear
echo "================================================="
echo "=== –£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –±–æ—Ç–∞ –¥–ª—è –æ—Ç–±–æ—Ä–∞ –≤ HataniSquad ==="
echo "================================================="
echo

# –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
read -p "‚û°Ô∏è  –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ Telegram-–±–æ—Ç–∞: " BOT_TOKEN
read -p "‚û°Ô∏è  –í–≤–µ–¥–∏—Ç–µ ID —á–∞—Ç–∞ –æ—Ç–±–æ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, -1001234567890): " CHAT_ID

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –≤–≤–µ–¥–µ–Ω—ã –Ω–µ –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
    echo "–û—à–∏–±–∫–∞: –¢–æ–∫–µ–Ω –∏ ID —á–∞—Ç–∞ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏."
    exit 1
fi

echo
echo "‚úÖ –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–Ω—è—Ç—ã. –ù–∞—á–∏–Ω–∞—é —É—Å—Ç–∞–Ω–æ–≤–∫—É..."
sleep 2

# --- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ---
echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤..."
apt-get update
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ (git, python, pip, redis, curl)..."
apt-get install -y git python3 python3-pip redis-server curl

# --- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js –∏ PM2 ---
echo "üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js (v20.x)..."
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
apt-get install -y nodejs
echo " pm2 - –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
npm install -g pm2

# --- –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è ---
# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ–º–∞—à–Ω—é—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—Å—Ç–∏–ª sudo
if [ -n "$SUDO_USER" ]; then
    TARGET_DIR="/home/$SUDO_USER/Selection-Hatani-Bot"
else
    TARGET_DIR="/root/Selection-Hatani-Bot"
fi

echo "üìÇ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ $TARGET_DIR..."
git clone https://github.com/Rewixx-png/Selection-Hatani-Bot.git "$TARGET_DIR"

if [ ! -d "$TARGET_DIR" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π."
    exit 1
fi
cd "$TARGET_DIR"

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞ ---
echo "‚öôÔ∏è  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞..."
# –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å —Ç–æ–∫–µ–Ω–æ–º
echo "$BOT_TOKEN" > token.txt
# –ò–∑–º–µ–Ω—è–µ–º ID —á–∞—Ç–∞ –≤ –∫–æ–Ω—Ñ–∏–≥–µ
sed -i "s/^CHAT_ID: int = .*/CHAT_ID: int = $CHAT_ID/" config.py

# --- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python-–±–∏–±–ª–∏–æ—Ç–µ–∫ ---
echo "üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–∑ requirements.txt..."
pip install -r requirements.txt
echo "üåê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–∞—É–∑–µ—Ä–∞ Chromium –¥–ª—è Playwright (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç)..."
python3 -m playwright install chromium

# --- –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ PM2 ---
echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ PM2..."
pm2 start main.py --name "selection-bot" --interpreter python3
echo "üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ PM2 –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞..."
pm2 save
echo "‚öôÔ∏è  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ PM2 –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å–µ—Ä–≤–µ—Ä–∞..."
# –≠—Ç–∞ –º–∞–≥–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—É, –∫–æ—Ç–æ—Ä—É—é –≤—ã–≤–æ–¥–∏—Ç `pm2 startup`
pm2 startup systemd -u $(logname) --hp /home/$(logname) | tail -n 1 | sudo -E bash -

echo
echo "================================================="
echo "üéâ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! üéâ"
echo "================================================="
echo "–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞—Ç—å—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏."
echo
echo "–ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  pm2 logs selection-bot  - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –±–æ—Ç–∞"
echo "  pm2 restart selection-bot - –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"
echo "  pm2 status              - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"
echo